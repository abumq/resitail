<!DOCTYPE html>
<html>
  <head>
    <title>Residue Logs</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="/styles/default.css">
    <link rel="icon" href="/favicon.ico">
  </head>
  <body>
    <input type="checkbox" id="chk-scroll" checked />
    <div id="log-lines"></ul>
    <script src="/scripts/socket.io-1.2.0.js"></script>
    <script src="/scripts/jquery-1.11.1.js"></script>
    <script src="/scripts/tinycon.min.js"></script>
    <script>
      var newLinesCount = 0;

      function updateFavIcon() {
        Tinycon.setBubble(newLinesCount);
      }

      function appendLine(html) {
        var div = document.createElement('div');
        div.innerHTML = html;
        document.getElementById('log-lines').appendChild(div.children[0]);
        newLinesCount++;

        window.setTimeout(function() {
          updateFavIcon();
          if ($("#chk-scroll").prop("checked")) {
            window.scrollTo(0, document.body.scrollHeight);
          }
        }, 800);
      }

      $(function () {

        $("#chk-scroll").change(function() {
          if ($(this).prop("checked")) {
            window.scrollTo(0, document.body.scrollHeight);
          }
        });

        window.addEventListener('focus', function() {
          newLinesCount = 0;
          updateFavIcon();
        }, true);

        var socket = io();

        socket.emit('resitail:connect', location.search);

        socket.on('resitail:line', function(line){
          appendLine('<p class=\'line\'>' + line + '</p>');
        });

        socket.on('resitail:err', function(line){
          appendLine('<p class=\'line\'><span class=\'line-err\'>' + line + '</span></p>');
        });
      });
    </script>
  </body>
</html>
